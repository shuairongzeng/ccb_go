# Droid Integration - Solution Design

> Generated by all-plan collaborative design process (Codex-led)

## Overview

**Goal**: Integrate Droid CLI (Factory.ai) as a first-class CCB provider with per-project session file binding and reliable reply capture.

**Readiness Score**: 83/100

**Generated**: 2026-01-21

---

## Requirements Summary

### Problem Statement
CCB needs to support Droid CLI (Factory.ai) alongside existing providers, with a concrete integration plan and a robust solution for session file routing, log binding, and cross-project isolation.

### Scope
In scope:
- New provider (Droid) in CCB provider lists and startup config.
- Per-project session file under `.ccb_config` with Droid session binding.
- Session reader and/or exec-mode bridge to capture replies.
- `dask/dpend/dping` CLI commands and daemon support.
- Commands must be callable from both Codex and Claude panes (sync/async).
- Session file overrides via `--session-file` and `CCB_SESSION_FILE`.
- Tests and docs updates.

Out of scope:
- Direct Factory API integration beyond CLI.
- UI changes in Factory web app.

### Success Criteria
- [ ] Automated tests cover session file resolution/override and log reader parsing.
- [ ] CCB can send a prompt to Droid and receive a reply with done marker.
- [ ] Correct project routing with multiple repos opened in parallel.

### Constraints
- Cross-platform (Linux/macOS/Windows/WSL) behavior must match existing CCB patterns.
- Preserve backward compatibility for existing providers and session files.
- Must work when Droid CLI is installed and authenticated (FACTORY_API_KEY or login).

### Assumptions
- Droid session logs are available locally under `~/.factory/sessions/<slug>/<session_id>.jsonl` and are JSONL with `type=session_start`, `id`, and `cwd`.
- The `~/.factory/logs/droid-log-single.log` file is plain text with embedded Context and is NOT used for session event parsing; session JSONL is the authoritative source.
- Droid TUI accepts newline submission (Enter sends, `\`+Enter for newline).
- Droid CLI does not restrict reading session JSONL files.

---

## Architecture

### Approach
- Add a new provider adapter (droid) that follows existing CCB patterns.
- Store a CCB-managed session file `.ccb_config/.droid-session` that binds:
  - CCB session id and project id
  - Droid session id
  - Session JSONL path (or exec-mode state)
  - Pane id/terminal info
- Implement a Droid session reader that scans `~/.factory/sessions` and filters by `session_start.cwd` or session id.
- Provide a fallback exec mode using `droid exec --session-id` with `--output-format stream-json` for deterministic parsing.

### Key Components
- **Provider spec**: add `droid` to `providers.py`, start config, allowed providers, status scripts.
- **Session file**: `.ccb_config/.droid-session` with `droid_session_id`, `droid_session_path`, `work_dir`, `terminal`, `pane_id`.
- **Session reader**: parse JSONL in `~/.factory/sessions`, handle partial writes, bind by `session_id` and/or `cwd`.
- **Daemon + CLI**: `daskd`, `dask`, `dpend`, `dping` mirroring existing provider commands.
- **Registry integration**: update `pane_registry` to include `droid` provider entries.

### Data Flow
1. User runs `ccb droid` in a project.
2. CCB starts `droid` in a pane, writes `.droid-session`, updates registry.
3. `dask` sends a wrapped prompt with `CCB_DONE` marker to the pane.
4. Session reader tails `~/.factory/sessions/<slug>/<session_id>.jsonl` (or exec output) and extracts the reply.
5. Session file is updated with the latest `droid_session_id` and JSONL path.

---

## Implementation Plan

### Step 1: Validate Droid Session JSONL Format
- **Actions**: confirm session JSONL location (`~/.factory/sessions/<slug>/<session_id>.jsonl`), `session_start` schema, and slug mapping for cwd across platforms.
- **Deliverables**: session JSONL schema notes + sample fixture for tests.
- **Dependencies**: Droid CLI installed and authenticated.

### Step 2: Provider Wiring + Session File Schema
- **Actions**: add `droid` provider in `providers.py`, `ccb_start_config.py`, `ccb` allowed providers list; design `.droid-session` schema and write helpers.
- **Deliverables**: new provider spec and session file writer/reader.
- **Dependencies**: Step 1.

### Step 3: Session Reader + Exec Fallback
- **Actions**: implement `droid_comm.py` with session JSONL reader and `DroidCommunicator`; add optional exec-mode path using `droid exec --session-id` and stream-json parsing.
- **Deliverables**: session reader + communicator module with tests for JSONL parsing.
- **Dependencies**: Step 1.

### Step 4: Daemon + CLI Commands
- **Actions**: implement `daskd_daemon.py`, `daskd_session.py`, `daskd_protocol.py`, and CLI wrappers (`dask`, `dpend`, `dping`); wire `CCB_SESSION_FILE` overrides.
- **Deliverables**: working ask/pend/ping flow with daemon support.
- **Dependencies**: Steps 2-3.

### Step 5: CCB Startup Integration
- **Actions**: add `_build_droid_start_cmd`, `_start_droid_tmux`, `_start_droid_current_pane`, `_write_droid_session`; update `config/ccb-status.sh`.
- **Deliverables**: CCB can start Droid in tmux/wezterm and record session metadata.
- **Dependencies**: Steps 2-4.

### Step 6: Tests + Docs
- **Actions**: add unit tests for session file override and log reader; update README and usage docs with `ccb droid` and `dask`.
- **Deliverables**: test coverage and user-facing documentation.
- **Dependencies**: Steps 3-5.

---

## Technical Considerations

- **Session binding**: treat `droid_session_path` as best-effort; refresh on every reply capture.
- **Cross-project isolation**: prefer `session_id` binding, fallback to `session_start.cwd` match.
- **Partial writes**: retry JSONL parsing on decode errors similar to Gemini reader.
- **Path resolution**: support Windows `%USERPROFILE%\.factory\sessions` and WSL path mapping.
- **Slug mapping**: implement robust lookup by scanning session_start entries when slug derivation is unknown.

---

## Risk Management

| Risk | Impact | Likelihood | Mitigation |
| ---- | ------ | ---------- | ---------- |
| Session JSONL schema differs between versions | High | Med | Validate schema in Step 1, add robust parsing + fallback exec mode |
| Session directory slug mapping differs across OS | Med | Med | Prefer `session_start.cwd` scan, not slug-only lookup |
| Session id not exposed for TUI | High | Med | Parse `session_start` entries or use exec mode |
| Authentication not present | Med | Low | Detect and show actionable error; document requirements |

---

## Acceptance Criteria

- [ ] `dask` can send a prompt and return a reply with `CCB_DONE` marker.
- [ ] `.droid-session` correctly binds `droid_session_id` and JSONL path for a project.
- [ ] `--session-file` and `CCB_SESSION_FILE` route to the correct project session.

---

## Design Contributors

| CLI | Key Contributions |
| --- | ----------------- |
| Codex | Provider wiring plan, session file schema, log reader/exec fallback strategy |
| OpenCode | Headless `droid exec` option, JSONL parsing considerations |
| Claude | Unavailable (no active session) |
| Gemini | Unavailable (async submission without response) |

---

## Appendix

### Clarification Summary

Readiness Score: 83/100

Dimensions:
- Problem Clarity: 27/30 (Defined)
- Functional Scope: 23/25 (Defined)
- Success Criteria: 18/20 (Defined)
- Constraints: 10/15 (Assumption)
- Priority/MVP: 5/10 (Assumption)

Assumptions & Gaps:
- Constraints: assume cross-platform compatibility and backward compatibility.
- Priority/MVP: assume iterative rollout; MVP focuses on log binding and ask/pend.

### Alternative Approaches Considered
- Use `droid exec` only (headless) and skip TUI integration.
- Direct API integration (not documented publicly; requires additional research).
- Manual log path input without session file binding (rejected due to routing risk).
